# *****************************************************************************
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# ******************************************************************************

FROM ubuntu:18.04

ARG NB_USER="dlab-user"
ENV CONF_FILE="/home/dlab-user/.local/share/jupyter/jupyter_notebook_config.py"
ENV PATH /usr/local/bin:$PATH
ENV LANG C.UTF-8
ENV DEBIAN_FRONTEND=noninteractive


RUN apt-get update && apt-get install -y --no-install-recommends \
                tk-dev wget gnupg dirmngr build-essential openssl \
                libreadline-gplv2-dev libncursesw5-dev libssl-dev \
                libsqlite3-dev libgdbm-dev libc6-dev libbz2-dev \
                python python-dev python-pip python-virtualenv \
                python3 python3-dev python3-pip default-jre default-jdk \
  && rm -rf /var/lib/apt/lists/*


RUN useradd -u 1001 -ms /bin/bash $NB_USER


#Installing Python libraries
RUN pip install --upgrade setuptools \
  && pip install tornado==4.5.3 ipython ipython matplotlib==2.0.2 \
   boto3 fabvenv fabric-virtualenv future NumPy==1.14.3 \
   SciPy pandas Sympy Pillow sklearn pyopenssl --no-cache-dir \
  && pip3 install --upgrade setuptools \
  && pip3 install tornado==4.5.3 ipython ipython matplotlib==2.0.2 \
   boto3 fabvenv fabric-virtualenv future NumPy==1.14.3 \
   SciPy pandas Sympy Pillow sklearn --no-cache-dir


#Installing SBT
#RUN apt-get install -y apt-transport-https \
#  && echo "deb https://dl.bintray.com/sbt/debian /" | tee -a /etc/apt/sources.list.d/sbt.list \
#  && apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 642AC823 \
#  && apt-get install -y sbt



#Installing Scala
RUN wget http://www.scala-lang.org/files/archive/scala-2.12.8.deb -O /tmp/scala.deb \
  && dpkg -i /tmp/scala.deb



#Installing Jupyter
RUN pip install notebook==jup_version --no-cache-dir \
  && pip install jupyter --no-cache-dir \
  && pip3 install notebook==jup_version --no-cache-dir \
  && pip3 install jupyter --no-cache-dir \
  && rm -rf $CONF_FILE \
  && mkdir -p /home/$NB_USER/.jupyter/custom/ \
  && echo "#notebook-container { width: auto; }" > /home/$NB_USER/.jupyter/custom/custom.css \
  && mkdir -p /mnt/var \
  && chown $NB_USER:$NB_USER /mnt/var \
  && jupyter-kernelspec remove -f python3 || echo "Such kernel doesnt exists" \
  && jupyter-kernelspec remove -f python2 || echo "Such kernel doesnt exists"
COPY jupyter_notebook_config.py /home/$NB_USER/.local/share/jupyter/jupyter_notebook_config.py

#Installing local kernel
RUN mkdir -p /home/$NB_USER/.local/share/jupyter/kernels/py3spark_local/ \
   /home/$NB_USER/.local/share/jupyter/kernels/pyspark_local/
COPY py3spark_local_kernel.json /home/$NB_USER/.local/share/jupyter/kernels/py3spark_local/kernel.json
COPY pyspark_local_kernel.json /home/$NB_USER/.local/share/jupyter/kernels/pyspark_local/kernel.json

EXPOSE 8888

#Prepearing Start script
COPY jupyter_run.sh /jupyter_run.sh
RUN  sed -i 's|CONF_PATH|/home/dlab-user/.local/share/jupyter/jupyter_notebook_config.py|' /jupyter_run.sh \
  && chmod +x /jupyter_run.sh \
  && chown -R 1001:1001 /home/$NB_USER/.local/share/jupyter

USER $NB_USER

ENTRYPOINT ["/jupyter_run.sh", "-d"]